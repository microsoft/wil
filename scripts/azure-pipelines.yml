# Windows Implementation Library Pipeline

trigger:
- master

jobs:
- job: BuildAndTest
  timeoutInMinutes: 360

  strategy:
    matrix:
      clang-x86-debug:
        compiler: clang
        arch: x86
        build-type: debug
      msvc-x86-debug:
        compiler: msvc
        arch: x86
        build-type: debug
      clang-x86-relwithdebinfo:
        compiler: clang
        arch: x86
        build-type: relwithdebinfo
      msvc-x86-relwithdebinfo:
        compiler: msvc
        arch: x86
        build-type: relwithdebinfo
      clang-x64-debug:
        compiler: clang
        arch: x64
        build-type: debug
      msvc-x64-debug:
        compiler: msvc
        arch: x64
        build-type: debug
      clang-x64-relwithdebinfo:
        compiler: clang
        arch: x64
        build-type: relwithdebinfo
      msvc-x64-relwithdebinfo:
        compiler: msvc
        arch: x64
        build-type: relwithdebinfo

  pool:
    vmImage: 'windows-2022'

  steps:
  - script: |
      choco install llvm
      if %ERRORLEVEL% NEQ 0 goto :eof
      echo ##vso[task.setvariable variable=PATH]%PATH%;C:\Program Files\LLVM\bin
    displayName: 'Install Clang'
    condition: eq(variables['compiler'], 'clang')

  - script: |
      call scripts\call-vcvars.cmd $(arch)
      if %ERRORLEVEL% NEQ 0 goto :eof
      
      call scripts\init.cmd -c $(compiler) -b $(build-type) --fast
      if %ERRORLEVEL% NEQ 0 goto :eof
      
      call scripts\build_all.cmd
    displayName: 'Build $(compiler) $(arch)$(build-type)'

  - script: |
      call scripts\call-vcvars.cmd $(arch)
      set ASAN_WIN_CONTINUE_ON_INTERCEPTION_FAILURE=1
      call scripts\runtests.cmd ~[LocalOnly]
    displayName: 'Test $(compiler) $(arch)$(build-type)'
